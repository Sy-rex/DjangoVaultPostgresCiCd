name: Deploy Django App

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  # –ü—Ä–∏–≤–æ–¥–∏–º –∏–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–ª—å–∑—è –≤ env, —Å–¥–µ–ª–∞–µ–º –≤ —à–∞–≥–∞—Ö
  K8S_NAMESPACE: django-app

jobs:
  build-and-deploy:
    # –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à self-hosted runner
    runs-on: self-hosted 
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Lowercase repo name
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          # –í–∞–∂–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –µ—Å–ª–∏ —Ä–∞–Ω–Ω–µ—Ä –Ω–∞ –º–∞–∫–µ, –∞ –∫–ª–∞—Å—Ç–µ—Ä –≥–¥–µ-—Ç–æ –µ—â–µ, –Ω–æ —É –Ω–∞—Å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω–æ
          platforms: linux/arm64 

      - name: Setup Kubernetes context
        run: |
          kubectl config use-context minikube

      - name: Build Vault Docker image in Minikube
        run: |
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Docker –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è minikube docker daemon
          eval $(minikube docker-env)
          
          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ Vault –∏–∑ Dockerfile –≤ minikube docker daemon
          docker build -t vault-custom:latest -f vault/Dockerfile vault/
          
          # –°–±—Ä–∞—Å—ã–≤–∞–µ–º docker env
          eval $(minikube docker-env -u)

      - name: Deploy and configure Vault
        run: |
          # –°–æ–∑–¥–∞–µ–º namespace vault
          kubectl create namespace vault --dry-run=client -o yaml | kubectl apply -f -
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã Vault
          kubectl apply -f k8s-manifests/vault/namespace.yaml
          kubectl apply -f k8s-manifests/vault/deployment.yaml
          kubectl apply -f k8s-manifests/vault/service.yaml
          
          # –û–∂–∏–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Vault pod
          echo "‚è≥ –û–∂–∏–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Vault..."
          kubectl wait --for=condition=ready pod -l app=vault -n vault --timeout=120s || true
          
          # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –ø–æ–ª–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
          sleep 15
          
          # –ü–æ–ª—É—á–∞–µ–º –∏–º—è pod Vault
          VAULT_POD=$(kubectl get pods -n vault -l app=vault -o jsonpath='{.items[0].metadata.name}')
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Vault (dev —Ä–µ–∂–∏–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç root —Ç–æ–∫–µ–Ω)
          export VAULT_ADDR="http://localhost:8200"
          export VAULT_TOKEN="root"
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º KV –¥–≤–∏–∂–æ–∫ –≤–µ—Ä—Å–∏–∏ 2 (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –≤–∫–ª—é—á–µ–Ω)
          echo "üìù –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º KV –¥–≤–∏–∂–æ–∫ –≤–µ—Ä—Å–∏–∏ 2..."
          kubectl exec $VAULT_POD -n vault -- sh -c 'VAULT_ADDR=http://localhost:8200 VAULT_TOKEN=root vault secrets enable -path=secret kv-v2' || echo "KV –¥–≤–∏–∂–æ–∫ —É–∂–µ –≤–∫–ª—é—á–µ–Ω"
          
          # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          echo "üíæ –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          kubectl exec $VAULT_POD -n vault -- sh -c 'VAULT_ADDR=http://localhost:8200 VAULT_TOKEN=root vault kv put secret/django-app/database \
            db_name="django_prod" \
            db_user="django_user" \
            db_password="SuperSecret123!" \
            secret_key="very-secret-key-prod"'
          
          # –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –¥–æ—Å—Ç—É–ø–∞
          echo "üìã –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –¥–æ—Å—Ç—É–ø–∞..."
          cat <<'POLICY_EOF' | kubectl exec -i $VAULT_POD -n vault -- sh -c 'VAULT_ADDR=http://localhost:8200 VAULT_TOKEN=root vault policy write django-app -' || echo "–ü–æ–ª–∏—Ç–∏–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
path "secret/data/django-app/*" {
  capabilities = ["read"]
}
POLICY_EOF
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–∫—Ä–µ—Ç—ã
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã..."
          kubectl exec $VAULT_POD -n vault -- sh -c 'VAULT_ADDR=http://localhost:8200 VAULT_TOKEN=root vault kv get secret/django-app/database' || true
          
          echo "‚úÖ Vault —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"

      - name: Deploy to Minikube
        run: |
          # –°–æ–∑–¥–∞–µ–º namespace –µ—Å–ª–∏ –Ω–µ—Ç
          kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          
          # –°–µ–∫—Ä–µ—Ç—ã (–°–º. –ø–æ—è—Å–Ω–µ–Ω–∏–µ –Ω–∏–∂–µ - —Ç.–∫. —ç—Ç–æ CI, —Å–µ–∫—Ä–µ—Ç –¥–æ–ª–∂–µ–Ω —É–∂–µ –±—ã—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è —Ç—É—Ç)
          # –í –ª–∞–±–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–ø—É—Å—Ç–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ –≤ CI
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
          kubectl apply -f k8s-manifests/namespace.yaml
          kubectl apply -f k8s-manifests/configmap.yaml
          kubectl apply -f k8s-manifests/postgres/
          kubectl apply -f k8s-manifests/deployment.yaml
          kubectl apply -f k8s-manifests/service.yaml
          kubectl apply -f k8s-manifests/ingress.yaml
          
          # –§–æ—Ä—Å–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–∞ (rollout restart)
          kubectl rollout restart deployment/django-deployment -n ${{ env.K8S_NAMESPACE }}
