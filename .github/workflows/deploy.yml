name: Deploy Django App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  K8S_NAMESPACE: django-app

jobs:
  build-and-deploy:
    # –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à self-hosted runner
    runs-on: self-hosted 
    
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kubernetes context
        run: |
          kubectl config use-context minikube

      - name: Build Django Docker image
        run: |
          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ Django –ª–æ–∫–∞–ª—å–Ω–æ
          docker build -t django-kubernetes-app:latest .
          
          # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–∑ –≤ minikube
          minikube image load django-kubernetes-app:latest

      - name: Build Vault Docker image
        run: |
          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ Vault –ª–æ–∫–∞–ª—å–Ω–æ
          docker build -t vault-custom:latest -f vault/Dockerfile vault/
          
          # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–∑ –≤ minikube
          minikube image load vault-custom:latest

      - name: Deploy and configure Vault
        shell: pwsh
        run: |
          # –°–æ–∑–¥–∞–µ–º namespace vault
          kubectl create namespace vault --dry-run=client -o yaml | kubectl apply -f -
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã Vault
          kubectl apply -f k8s-manifests/vault/namespace.yaml
          kubectl apply -f k8s-manifests/vault/deployment.yaml
          kubectl apply -f k8s-manifests/vault/service.yaml
          
          # –û–∂–∏–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Vault pod
          Write-Host "‚è≥ –û–∂–∏–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Vault..."
          kubectl wait --for=condition=ready pod -l app=vault -n vault --timeout=120s
          
          # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –ø–æ–ª–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
          Start-Sleep -Seconds 15
          
          # –ü–æ–ª—É—á–∞–µ–º –∏–º—è pod Vault
          $VAULT_POD = kubectl get pods -n vault -l app=vault -o jsonpath='{.items[0].metadata.name}'
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º KV –¥–≤–∏–∂–æ–∫ –≤–µ—Ä—Å–∏–∏ 2 (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –≤–∫–ª—é—á–µ–Ω)
          Write-Host "üìù –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º KV –¥–≤–∏–∂–æ–∫ –≤–µ—Ä—Å–∏–∏ 2..."
          kubectl exec $VAULT_POD -n vault -- sh -c "VAULT_ADDR=http://localhost:8200 VAULT_TOKEN=root vault secrets enable -path=secret kv-v2" 2>&1 | Out-Null
          if ($LASTEXITCODE -ne 0) { Write-Host "KV –¥–≤–∏–∂–æ–∫ —É–∂–µ –≤–∫–ª—é—á–µ–Ω" }
          
          # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          Write-Host "üíæ –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          kubectl exec $VAULT_POD -n vault -- sh -c "VAULT_ADDR=http://localhost:8200 VAULT_TOKEN=root vault kv put secret/django-app/database db_name=django_prod db_user=django_user db_password=SuperSecret123! secret_key=very-secret-key-prod"
          
          # –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –¥–æ—Å—Ç—É–ø–∞
          Write-Host "üìã –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –¥–æ—Å—Ç—É–ø–∞..."
          $policy = 'path "secret/data/django-app/*" { capabilities = ["read"] }'
          echo $policy | kubectl exec -i $VAULT_POD -n vault -- sh -c "VAULT_ADDR=http://localhost:8200 VAULT_TOKEN=root vault policy write django-app -" 2>&1 | Out-Null
          if ($LASTEXITCODE -ne 0) { Write-Host "–ü–æ–ª–∏—Ç–∏–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" }
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–∫—Ä–µ—Ç—ã
          Write-Host "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã..."
          kubectl exec $VAULT_POD -n vault -- sh -c "VAULT_ADDR=http://localhost:8200 VAULT_TOKEN=root vault kv get secret/django-app/database" 2>&1
          
          Write-Host "‚úÖ Vault —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"

      - name: Deploy to Minikube
        run: |
          # –°–æ–∑–¥–∞–µ–º namespace –µ—Å–ª–∏ –Ω–µ—Ç
          kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          
          # –°–µ–∫—Ä–µ—Ç—ã (–°–º. –ø–æ—è—Å–Ω–µ–Ω–∏–µ –Ω–∏–∂–µ - —Ç.–∫. —ç—Ç–æ CI, —Å–µ–∫—Ä–µ—Ç –¥–æ–ª–∂–µ–Ω —É–∂–µ –±—ã—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è —Ç—É—Ç)
          # –í –ª–∞–±–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–ø—É—Å—Ç–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ –≤ CI
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
          kubectl apply -f k8s-manifests/namespace.yaml
          kubectl apply -f k8s-manifests/configmap.yaml
          kubectl apply -f k8s-manifests/postgres/
          kubectl apply -f k8s-manifests/deployment.yaml
          kubectl apply -f k8s-manifests/service.yaml
          kubectl apply -f k8s-manifests/ingress.yaml
          
          # –§–æ—Ä—Å–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–∞ (rollout restart)
          kubectl rollout restart deployment/django-deployment -n ${{ env.K8S_NAMESPACE }}
